generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  OWNER
  ADMIN
  ACCOUNTANT
  MEMBER
}

model User {
  id           String  @id @default(uuid())
  email        String  @unique
  passwordHash String?
  firstName    String?
  lastName     String?

  emailVerified Boolean @default(false)
  isActive      Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  memberships Membership[]
  sessions    Session[]
  tokens      AuthToken[]
  accounts    Account[] // OAuth providers
}

model Account {
  id                String    @id @default(uuid())
  userId            String
  provider          String
  providerAccountId String
  accessToken       String?
  refreshToken      String?
  expiresAt         DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Organization {
  id   String @id @default(uuid())
  name String
  slug String @unique

  defaultCurrency String @default("USD")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  memberships  Membership[]
  invoices     Invoice[]
  quotes       Quote[]
  expenses     Expense[]
  clients      Client[]
  vendors      Vendor[]
  categories   ExpenseCategory[]
  products     Product[]
  subscription Subscription?
}

model Membership {
  id String @id @default(uuid())

  userId         String
  organizationId String

  role UserRole @default(MEMBER)

  createdAt DateTime @default(now())

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum TokenType {
  VERIFY_EMAIL
  RESET_PASSWORD
  INVITE_USER
}

model AuthToken {
  id        String    @id @default(uuid())
  userId    String
  token     String    @unique
  type      TokenType
  expiresAt DateTime
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum PlanType {
  FREE
  STARTER
  PRO
  BUSINESS
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  TRIALING
}

model Plan {
  id           String   @id @default(uuid())
  name         PlanType @unique
  priceMonthly Decimal  @db.Decimal(10, 2)
  priceYearly  Decimal  @db.Decimal(10, 2)

  maxInvoices Int?
  maxExpenses Int?
  maxUsers    Int?

  createdAt DateTime @default(now())

  subscriptions Subscription[]
}

model Subscription {
  id             String @id @default(uuid())
  organizationId String @unique
  planId         String

  status            SubscriptionStatus
  currentPeriodEnd  DateTime
  cancelAtPeriodEnd Boolean            @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  plan         Plan         @relation(fields: [planId], references: [id])
}

model Currency {
  code   String @id
  name   String
  symbol String
}

enum ClientType {
  INDIVIDUAL
  COMPANY
}

model Client {
  id             String @id @default(uuid())
  organizationId String

  name    String
  email   String?
  phone   String?
  address String?
  type    ClientType @default(INDIVIDUAL)

  createdAt DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invoices     Invoice[]
  quotes       Quote[]
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  PARTIAL
  OVERDUE
  CANCELLED
}

model Invoice {
  id             String  @id @default(uuid())
  organizationId String
  clientId       String?

  number String
  status InvoiceStatus @default(DRAFT)

  issueDate DateTime
  dueDate   DateTime?

  subtotal Decimal @db.Decimal(18, 2)
  taxTotal Decimal @db.Decimal(18, 2)
  total    Decimal @db.Decimal(18, 2)

  currencyCode String
  exchangeRate Decimal? @db.Decimal(18, 6)

  originQuoteId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client       Client?       @relation(fields: [clientId], references: [id])
  items        InvoiceItem[]
  payments     Payment[]
}

model InvoiceItem {
  id        String @id @default(uuid())
  invoiceId String

  name        String
  description String?
  quantity    Decimal  @db.Decimal(18, 2)
  unitPrice   Decimal  @db.Decimal(18, 2)
  taxRate     Decimal?
  total       Decimal  @db.Decimal(18, 2)
  isService   Boolean  @default(false)

  invoice   Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  product   Product? @relation(fields: [productId], references: [id])
  productId String?
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
  MOBILE_MONEY
  CARD
}

model Payment {
  id        String @id @default(uuid())
  invoiceId String

  amount Decimal       @db.Decimal(18, 2)
  method PaymentMethod
  paidAt DateTime

  createdAt DateTime @default(now())

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
}

enum QuoteStatus {
  DRAFT
  SENT
  ACCEPTED
  REJECTED
  EXPIRED
}

model Quote {
  id             String  @id @default(uuid())
  organizationId String
  clientId       String?

  number String
  status QuoteStatus @default(DRAFT)

  issueDate  DateTime
  expiryDate DateTime?

  subtotal Decimal @db.Decimal(18, 2)
  taxTotal Decimal @db.Decimal(18, 2)
  total    Decimal @db.Decimal(18, 2)

  currencyCode String
  exchangeRate Decimal? @db.Decimal(18, 6)

  createdAt DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client       Client?      @relation(fields: [clientId], references: [id])
  items        QuoteItem[]
}

model QuoteItem {
  id      String @id @default(uuid())
  quoteId String

  name        String
  description String?
  quantity    Decimal  @db.Decimal(18, 2)
  unitPrice   Decimal  @db.Decimal(18, 2)
  taxRate     Decimal?
  total       Decimal  @db.Decimal(18, 2)
  isService   Boolean  @default(false)

  quote     Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  product   Product? @relation(fields: [productId], references: [id])
  productId String?
}

model Expense {
  id             String  @id @default(uuid())
  organizationId String
  vendorId       String?

  title       String
  description String?

  subtotal    Decimal  @db.Decimal(18, 2)
  taxAmount   Decimal?
  totalAmount Decimal  @db.Decimal(18, 2)

  currencyCode String
  exchangeRate Decimal? @db.Decimal(18, 6)

  expenseDate DateTime
  receiptUrl  String?

  categoryId String

  createdAt DateTime @default(now())

  organization Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  category     ExpenseCategory @relation(fields: [categoryId], references: [id])
  vendor       Vendor?         @relation(fields: [vendorId], references: [id])
}

model ExpenseCategory {
  id             String @id @default(uuid())
  organizationId String
  name           String

  createdAt    DateTime     @default(now())
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  expenses     Expense[]
}

model Vendor {
  id             String  @id @default(uuid())
  organizationId String
  name           String
  email          String?
  phone          String?
  address        String?

  createdAt    DateTime     @default(now())
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  expenses     Expense[]
}

model Product {
  id             String   @id @default(uuid())
  organizationId String
  name           String
  description    String?
  sku            String?
  price          Decimal  @db.Decimal(18, 2)
  isService      Boolean  @default(false)
  stockQuantity  Decimal? @db.Decimal(18, 2) // pour inventaire futur

  createdAt DateTime @default(now())

  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invoiceItems InvoiceItem[]
  quoteItems   QuoteItem[]
}
