generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================================
// AUTH — Better-Auth compatible
// ============================================================

enum UserRole {
  OWNER
  ADMIN
  ACCOUNTANT
  MEMBER
}

model User {
  id          String  @id @default(uuid())
  email       String  @unique
  name        String?
  phoneNumber String? @unique
  password    String?
  image       String?

  emailVerified       Boolean @default(false)
  phoneNumberVerified Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sessions    Session[]
  accounts    Account[]
  memberships Membership[]
}

model Session {
  id        String   @id @default(uuid())
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ipAddress String?
  userAgent String?

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Account {
  id         String @id @default(uuid())
  accountId  String
  providerId String

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([providerId, accountId])
  @@index([userId])
}

// Requis par Better-Auth pour OTP, email verification, reset password, etc.
model Verification {
  id         String   @id @default(uuid())
  identifier String // email ou phone
  value      String // le token / code OTP
  expiresAt  DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([identifier])
}

// ============================================================
// ORGANISATION & MEMBERSHIP
// ============================================================

model Organization {
  id   String @id @default(uuid())
  name String
  slug String @unique

  defaultCurrency String @default("USD")

  // Infos de facturation de l'org (affiché sur les factures/devis)
  address String?
  phone   String?
  email   String?
  website String?
  taxId   String? // numéro de TVA / SIRET / etc.
  logoUrl String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  memberships  Membership[]
  invoices     Invoice[]
  quotes       Quote[]
  expenses     Expense[]
  clients      Client[]
  vendors      Vendor[]
  categories   ExpenseCategory[]
  products     Product[]
  taxRates     TaxRate[]
  subscription Subscription?
}

model Membership {
  id String @id @default(uuid())

  userId         String
  organizationId String

  role UserRole @default(MEMBER)

  createdAt DateTime @default(now())

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@index([organizationId])
}

// ============================================================
// PLANS & ABONNEMENTS
// ============================================================

enum PlanType {
  FREE
  STARTER
  PRO
  BUSINESS
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  TRIALING
}

model Plan {
  id           String   @id @default(uuid())
  name         PlanType @unique
  priceMonthly Decimal  @db.Decimal(10, 2)
  priceYearly  Decimal  @db.Decimal(10, 2)

  maxInvoices Int?
  maxExpenses Int?
  maxUsers    Int?
  maxProducts Int?

  createdAt DateTime @default(now())

  subscriptions Subscription[]
}

model Subscription {
  id             String @id @default(uuid())
  organizationId String @unique
  planId         String

  status            SubscriptionStatus
  currentPeriodEnd  DateTime
  cancelAtPeriodEnd Boolean            @default(false)

  // ID externe (Stripe, etc.)
  externalId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  plan         Plan         @relation(fields: [planId], references: [id])
}

// ============================================================
// RÉFÉRENTIELS
// ============================================================

model Currency {
  code   String @id
  name   String
  symbol String
}

// Taux de TVA réutilisables par organisation
model TaxRate {
  id             String @id @default(uuid())
  organizationId String

  name      String // ex: "TVA 20%", "TVA réduite 5.5%"
  rate      Decimal @db.Decimal(5, 2) // ex: 20.00
  isDefault Boolean @default(false)

  createdAt DateTime @default(now())

  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invoiceItems InvoiceItem[]
  quoteItems   QuoteItem[]

  @@index([organizationId])
}

model Product {
  id             String @id @default(uuid())
  organizationId String

  name          String
  description   String?
  sku           String?
  price         Decimal  @db.Decimal(18, 2)
  isService     Boolean  @default(false)
  stockQuantity Decimal? @db.Decimal(18, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invoiceItems InvoiceItem[]
  quoteItems   QuoteItem[]

  @@index([organizationId])
}

// ============================================================
// CLIENTS & FOURNISSEURS
// ============================================================

enum ClientType {
  INDIVIDUAL
  COMPANY
}

model Client {
  id             String @id @default(uuid())
  organizationId String

  name    String
  email   String?
  phone   String?
  address String?
  city    String?
  country String?
  taxId   String? // TVA intracommunautaire, SIRET, etc.
  type    ClientType @default(INDIVIDUAL)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invoices     Invoice[]
  quotes       Quote[]

  @@index([organizationId])
}

model Vendor {
  id             String @id @default(uuid())
  organizationId String

  name    String
  email   String?
  phone   String?
  address String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  expenses     Expense[]

  @@index([organizationId])
}

// ============================================================
// FACTURES
// ============================================================

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  PARTIAL
  OVERDUE
  CANCELLED
}

model Invoice {
  id             String  @id @default(uuid())
  organizationId String
  clientId       String?

  number String
  status InvoiceStatus @default(DRAFT)

  issueDate DateTime
  dueDate   DateTime?

  subtotal Decimal @db.Decimal(18, 2)
  taxTotal Decimal @db.Decimal(18, 2)
  total    Decimal @db.Decimal(18, 2)

  currencyCode String
  exchangeRate Decimal? @db.Decimal(18, 6)

  // Notes affichées sur la facture
  notes         String?
  // Conditions de paiement affichées sur la facture
  terms         String?
  // Notes internes, non visibles par le client
  internalNotes String?

  // Lien vers le devis d'origine si converti
  originQuoteId String?
  originQuote   Quote?  @relation("QuoteToInvoice", fields: [originQuoteId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client       Client?       @relation(fields: [clientId], references: [id])
  items        InvoiceItem[]
  payments     Payment[]

  // Numéro unique par organisation
  @@unique([organizationId, number])
  @@index([organizationId])
  @@index([clientId])
  @@index([status])
  @@index([organizationId, status])
  @@index([dueDate])
}

model InvoiceItem {
  id        String @id @default(uuid())
  invoiceId String

  name        String
  description String?
  quantity    Decimal @db.Decimal(18, 2)
  unitPrice   Decimal @db.Decimal(18, 2)
  total       Decimal @db.Decimal(18, 2)
  isService   Boolean @default(false)

  // Relation vers TaxRate pour réutilisabilité
  taxRateId String?
  taxRate   TaxRate? @relation(fields: [taxRateId], references: [id])

  productId String?
  product   Product? @relation(fields: [productId], references: [id])

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
  MOBILE_MONEY
  CARD
  CHECK
  OTHER
}

model Payment {
  id        String @id @default(uuid())
  invoiceId String

  amount Decimal       @db.Decimal(18, 2)
  method PaymentMethod
  paidAt DateTime
  note   String?

  createdAt DateTime @default(now())

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
}

// ============================================================
// DEVIS
// ============================================================

enum QuoteStatus {
  DRAFT
  SENT
  ACCEPTED
  REJECTED
  EXPIRED
}

model Quote {
  id             String  @id @default(uuid())
  organizationId String
  clientId       String?

  number String
  status QuoteStatus @default(DRAFT)

  issueDate  DateTime
  expiryDate DateTime?

  subtotal Decimal @db.Decimal(18, 2)
  taxTotal Decimal @db.Decimal(18, 2)
  total    Decimal @db.Decimal(18, 2)

  currencyCode String
  exchangeRate Decimal? @db.Decimal(18, 6)

  notes         String?
  terms         String?
  internalNotes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client       Client?      @relation(fields: [clientId], references: [id])
  items        QuoteItem[]

  // Factures générées depuis ce devis
  invoices Invoice[] @relation("QuoteToInvoice")

  @@unique([organizationId, number])
  @@index([organizationId])
  @@index([clientId])
  @@index([status])
  @@index([organizationId, status])
}

model QuoteItem {
  id      String @id @default(uuid())
  quoteId String

  name        String
  description String?
  quantity    Decimal @db.Decimal(18, 2)
  unitPrice   Decimal @db.Decimal(18, 2)
  total       Decimal @db.Decimal(18, 2)
  isService   Boolean @default(false)

  taxRateId String?
  taxRate   TaxRate? @relation(fields: [taxRateId], references: [id])

  productId String?
  product   Product? @relation(fields: [productId], references: [id])

  quote Quote @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([quoteId])
}

// ============================================================
// DÉPENSES
// ============================================================

model ExpenseCategory {
  id             String  @id @default(uuid())
  organizationId String
  name           String
  color          String? // pour l'UI / graphiques

  createdAt    DateTime     @default(now())
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  expenses     Expense[]

  @@index([organizationId])
}

model Expense {
  id             String  @id @default(uuid())
  organizationId String
  vendorId       String?
  categoryId     String

  title       String
  description String?

  subtotal    Decimal  @db.Decimal(18, 2)
  taxAmount   Decimal? @db.Decimal(18, 2)
  totalAmount Decimal  @db.Decimal(18, 2)

  currencyCode String
  exchangeRate Decimal? @db.Decimal(18, 6)

  expenseDate DateTime
  receiptUrl  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  category     ExpenseCategory @relation(fields: [categoryId], references: [id])
  vendor       Vendor?         @relation(fields: [vendorId], references: [id])

  @@index([organizationId])
  @@index([organizationId, expenseDate])
  @@index([categoryId])
}
